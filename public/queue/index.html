<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila de Postagens - PostPilot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../build/css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>PostPilot</h3>
            </div>

            <ul class="list-unstyled components">
                <li>
                    <a href="../dashboard/index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                </li>
                <li>
                    <a href="../posts/index.html"><i class="fas fa-file-alt"></i> Postagens</a>
                </li>
                <li>
                    <a href="../posts/calendar.html"><i class="fas fa-calendar"></i> Calendário</a>
                </li>
                <li>
                    <a href="../prompts/index.html"><i class="fas fa-lightbulb"></i> Templates de IA</a>
                </li>
                <li class="active">
                    <a href="index.html"><i class="fas fa-tasks"></i> Fila de Postagens</a>
                </li>
                <li>
                    <a href="../categories/index.html"><i class="fas fa-folder"></i> Categorias</a>
                </li>
                <li>
                    <a href="../tags/index.html"><i class="fas fa-tags"></i> Tags</a>
                </li>
                <li>
                    <a href="../reports/index.html"><i class="fas fa-chart-bar"></i> Relatórios</a>
                </li>
                <li>
                    <a href="../settings/index.html"><i class="fas fa-cog"></i> Configurações</a>
                </li>
                <li>
                    <a href="../subscription/index.html"><i class="fas fa-star"></i> Assinatura</a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-info">
                        <i class="fas fa-align-left"></i>
                        <span>Menu</span>
                    </button>
                    <div class="d-flex">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user"></i> <span id="username">Usuário</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="../settings/index.html">Perfil</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logout">Sair</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h2>Fila de Postagens</h2>
                        <p>Gerencie suas postagens agendadas e monitore o status de publicação.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="../posts/create.html" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nova Postagem
                        </a>
                    </div>
                </div>

                <!-- Estatísticas da Fila -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Pendentes</h5>
                                <h2 id="pendingCount">0</h2>
                                <p class="card-text">Postagens aguardando publicação</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">Em Processamento</h5>
                                <h2 id="processingCount">0</h2>
                                <p class="card-text">Postagens sendo publicadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Publicadas</h5>
                                <h2 id="publishedCount">0</h2>
                                <p class="card-text">Postagens publicadas com sucesso</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">Falhas</h5>
                                <h2 id="failedCount">0</h2>
                                <p class="card-text">Postagens com erro de publicação</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="statusFilter">Status</label>
                                    <select class="form-control" id="statusFilter">
                                        <option value="all">Todos</option>
                                        <option value="pending">Pendentes</option>
                                        <option value="processing">Em Processamento</option>
                                        <option value="published">Publicadas</option>
                                        <option value="failed">Falhas</option>
                                        <option value="cancelled">Canceladas</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dateFilter">Data</label>
                                    <select class="form-control" id="dateFilter">
                                        <option value="all">Todas</option>
                                        <option value="today">Hoje</option>
                                        <option value="tomorrow">Amanhã</option>
                                        <option value="this_week">Esta Semana</option>
                                        <option value="next_week">Próxima Semana</option>
                                        <option value="this_month">Este Mês</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="searchFilter">Buscar</label>
                                    <input type="text" class="form-control" id="searchFilter" placeholder="Título ou conteúdo...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Postagens na Fila -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Postagens na Fila</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" id="refreshQueueBtn">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="saveOrderBtn" disabled>
                                <i class="fas fa-save"></i> Salvar Ordem
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i> Arraste as postagens para reordenar a fila. Postagens com maior prioridade serão publicadas primeiro.
                        </div>
                        
                        <div id="queueList" class="list-group">
                            <!-- As postagens na fila serão inseridas aqui dinamicamente -->
                            <div class="text-center py-5" id="loadingQueue">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2">Carregando fila de postagens...</p>
                            </div>
                        </div>
                        
                        <!-- Mensagem de nenhum resultado -->
                        <div id="noResults" class="alert alert-info text-center d-none">
                            Nenhuma postagem encontrada na fila com os filtros selecionados.
                        </div>
                    </div>
                </div>

                <!-- Próxima Postagem Agendada -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Próxima Postagem Agendada</h5>
                    </div>
                    <div class="card-body">
                        <div id="nextScheduledContainer">
                            <!-- Conteúdo será inserido dinamicamente -->
                            <div class="text-center" id="loadingNextScheduled">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Postagens Recentes -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Publicações Recentes</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentlyPublishedContainer">
                                    <!-- Conteúdo será inserido dinamicamente -->
                                    <div class="text-center" id="loadingRecentlyPublished">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Falhas Recentes</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentlyFailedContainer">
                                    <!-- Conteúdo será inserido dinamicamente -->
                                    <div class="text-center" id="loadingRecentlyFailed">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Postagem -->
    <div class="modal fade" id="postDetailsModal" tabindex="-1" aria-labelledby="postDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postDetailsModalLabel">Detalhes da Postagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Título</h6>
                            <p id="modalPostTitle">Carregando...</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Status</h6>
                            <p id="modalPostStatus">Carregando...</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Data de Agendamento</h6>
                            <p id="modalPostScheduledAt">Carregando...</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Data de Publicação</h6>
                            <p id="modalPostPublishedAt">Carregando...</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Categoria</h6>
                            <p id="modalPostCategory">Carregando...</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Tentativas</h6>
                            <p id="modalPostRetryCount">Carregando...</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Conteúdo</h6>
                        <div id="modalPostContent" class="border rounded p-3 bg-light">Carregando...</div>
                    </div>
                    <div id="modalPostFailureReason" class="alert alert-danger d-none">
                        <h6>Motivo da Falha</h6>
                        <p id="modalPostFailureReasonText">Carregando...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <a href="#" id="modalPostEditBtn" class="btn btn-primary">Editar</a>
                    <button type="button" id="modalPostRetryBtn" class="btn btn-warning d-none">Tentar Novamente</button>
                    <button type="button" id="modalPostCancelBtn" class="btn btn-danger d-none">Cancelar Agendamento</button>
                    <button type="button" id="modalPostProcessNowBtn" class="btn btn-success d-none">Publicar Agora</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.2/marked.min.js"></script>
    <script src="../build/js/auth.js"></script>
    <script src="../build/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            if (!api.isAuthenticated()) {
                window.location.href = '../login.html';
                return;
            }

            // Exibir nome do usuário
            const user = api.getCurrentUser();
            if (user) {
                document.getElementById('username').textContent = user.name;
            }

            // Logout
            document.getElementById('logout').addEventListener('click', async function(e) {
                e.preventDefault();
                try {
                    await api.auth.logout();
                    window.location.href = '../login.html';
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    alert('Erro ao fazer logout. Por favor, tente novamente.');
                }
            });

            // Toggle sidebar
            document.getElementById('sidebarCollapse').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });

            // Carregar dados da fila
            loadQueueData();
            
            // Configurar Sortable.js para reordenação
            const queueList = document.getElementById('queueList');
            const sortable = new Sortable(queueList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: function() {
                    // Habilitar botão de salvar ordem
                    document.getElementById('saveOrderBtn').disabled = false;
                }
            });
            
            // Botão de salvar ordem
            document.getElementById('saveOrderBtn').addEventListener('click', async function() {
                const postIds = Array.from(queueList.querySelectorAll('.queue-item'))
                    .map(item => parseInt(item.getAttribute('data-id')));
                
                if (postIds.length === 0) {
                    return;
                }
                
                try {
                    await saveQueueOrder(postIds);
                    showAlert('Ordem da fila salva com sucesso!', 'success');
                    document.getElementById('saveOrderBtn').disabled = true;
                } catch (error) {
                    console.error('Erro ao salvar ordem da fila:', error);
                    showAlert('Erro ao salvar ordem da fila. Por favor, tente novamente.', 'danger');
                }
            });
            
            // Botão de atualizar fila
            document.getElementById('refreshQueueBtn').addEventListener('click', function() {
                loadQueueData();
            });
            
            // Filtros
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
            
            // Configurar polling para atualização automática
            setInterval(loadQueueData, 30000); // Atualizar a cada 30 segundos
        });

        // Função para carregar dados da fila
        async function loadQueueData() {
            try {
                // Carregar estatísticas
                const stats = await api.queue.getStats();
                updateStats(stats);
                
                // Carregar postagens na fila
                const response = await api.queue.getAll();
                const posts = response.posts;
                
                // Remover spinner de carregamento
                document.getElementById('loadingQueue').classList.add('d-none');
                
                // Limpar lista atual
                const queueList = document.getElementById('queueList');
                const queueItems = queueList.querySelectorAll('.queue-item');
                queueItems.forEach(item => item.remove());
                
                // Adicionar postagens à lista
                if (posts && posts.length > 0) {
                    posts.forEach(post => {
                        const queueItem = createQueueItem(post);
                        queueList.appendChild(queueItem);
                    });
                    document.getElementById('noResults').classList.add('d-none');
                } else {
                    document.getElementById('noResults').classList.remove('d-none');
                }
                
                // Aplicar filtros atuais
                applyFilters();
                
            } catch (error) {
                console.error('Erro ao carregar dados da fila:', error);
                showAlert('Erro ao carregar dados da fila. Por favor, tente novamente.', 'danger');
            }
        }

        // Função para atualizar estatísticas
        function updateStats(stats) {
            document.getElementById('pendingCount').textContent = stats.counts.pending;
            document.getElementById('processingCount').textContent = stats.counts.processing;
            document.getElementById('publishedCount').textContent = stats.counts.published;
            document.getElementById('failedCount').textContent = stats.counts.failed;
            
            // Atualizar próxima postagem agendada
            const nextScheduledContainer = document.getElementById('nextScheduledContainer');
            document.getElementById('loadingNextScheduled').classList.add('d-none');
            
            if (stats.next_scheduled) {
                const post = stats.next_scheduled;
                const scheduledDate = new Date(post.scheduled_at);
                
                nextScheduledContainer.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>${post.title}</h5>
                            <p class="mb-1">
                                <strong>Agendada para:</strong> ${formatDateTime(scheduledDate)}
                            </p>
                            <p class="mb-0">
                                <span class="badge bg-${getStatusBadgeClass(post.queue_status)}">${getStatusLabel(post.queue_status)}</span>
                                ${post.category_id ? `<span class="badge bg-secondary">${post.category?.name || 'Categoria'}</span>` : ''}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-primary view-post-btn" data-id="${post.id}">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>
                `;
            } else {
                nextScheduledContainer.innerHTML = '<p class="text-center text-muted">Nenhuma postagem agendada.</p>';
            }
            
            // Atualizar publicações recentes
            const recentlyPublishedContainer = document.getElementById('recentlyPublishedContainer');
            document.getElementById('loadingRecentlyPublished').classList.add('d-none');
            
            if (stats.recently_published && stats.recently_published.length > 0) {
                let html = '<div class="list-group">';
                stats.recently_published.forEach(post => {
                    const publishedDate = new Date(post.published_at);
                    html += `
                        <a href="#" class="list-group-item list-group-item-action view-post-btn" data-id="${post.id}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${post.title}</h6>
                                <small>${formatDateTime(publishedDate)}</small>
                            </div>
                            <p class="mb-1">${truncateText(post.content, 100)}</p>
                        </a>
                    `;
                });
                html += '</div>';
                recentlyPublishedContainer.innerHTML = html;
            } else {
                recentlyPublishedContainer.innerHTML = '<p class="text-center text-muted">Nenhuma publicação recente.</p>';
            }
            
            // Atualizar falhas recentes
            const recentlyFailedContainer = document.getElementById('recentlyFailedContainer');
            document.getElementById('loadingRecentlyFailed').classList.add('d-none');
            
            if (stats.recently_failed && stats.recently_failed.length > 0) {
                let html = '<div class="list-group">';
                stats.recently_failed.forEach(post => {
                    const lastAttemptDate = new Date(post.last_attempt_at);
                    html += `
                        <a href="#" class="list-group-item list-group-item-action view-post-btn" data-id="${post.id}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${post.title}</h6>
                                <small>${formatDateTime(lastAttemptDate)}</small>
                            </div>
                            <p class="mb-1">${truncateText(post.failure_reason || 'Erro desconhecido', 100)}</p>
                        </a>
                    `;
                });
                html += '</div>';
                recentlyFailedContainer.innerHTML = html;
            } else {
                recentlyFailedContainer.innerHTML = '<p class="text-center text-muted">Nenhuma falha recente.</p>';
            }
            
            // Configurar eventos para botões de visualização
            document.querySelectorAll('.view-post-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const postId = this.getAttribute('data-id');
                    showPostDetails(postId);
                });
            });
        }

        // Função para criar item da fila
        function createQueueItem(post) {
            const div = document.createElement('div');
            div.className = 'list-group-item queue-item';
            div.setAttribute('data-id', post.id);
            div.setAttribute('data-status', post.queue_status);
            div.setAttribute('data-date', post.scheduled_at);
            div.setAttribute('data-title', post.title);
            
            const scheduledDate = new Date(post.scheduled_at);
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="drag-handle me-3">
                            <i class="fas fa-grip-vertical text-muted"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">${post.title}</h5>
                            <p class="mb-1">
                                <strong>Agendada para:</strong> ${formatDateTime(scheduledDate)}
                                <span class="badge bg-${getStatusBadgeClass(post.queue_status)}">${getStatusLabel(post.queue_status)}</span>
                                ${post.category_id ? `<span class="badge bg-secondary">${post.category?.name || 'Categoria'}</span>` : ''}
                            </p>
                            ${post.failure_reason ? `<p class="text-danger mb-0"><small><i class="fas fa-exclamation-triangle"></i> ${truncateText(post.failure_reason, 100)}</small></p>` : ''}
                        </div>
                    </div>
                    <div class="queue-item-actions">
                        <button class="btn btn-sm btn-primary view-post-btn" data-id="${post.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${post.queue_status === 'failed' ? `
                            <button class="btn btn-sm btn-warning retry-post-btn" data-id="${post.id}">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                        ` : ''}
                        ${post.queue_status === 'pending' ? `
                            <button class="btn btn-sm btn-success process-now-btn" data-id="${post.id}">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-danger cancel-post-btn" data-id="${post.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Configurar eventos para botões
            div.querySelector('.view-post-btn').addEventListener('click', function() {
                showPostDetails(post.id);
            });
            
            const retryBtn = div.querySelector('.retry-post-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    retryPost(post.id);
                });
            }
            
            const cancelBtn = div.querySelector('.cancel-post-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    cancelPost(post.id);
                });
            }
            
            const processNowBtn = div.querySelector('.process-now-btn');
            if (processNowBtn) {
                processNowBtn.addEventListener('click', function() {
                    processPostNow(post.id);
                });
            }
            
            return div;
        }

        // Função para aplicar filtros
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            const queueItems = document.querySelectorAll('.queue-item');
            let visibleCount = 0;
            
            queueItems.forEach(item => {
                const status = item.getAttribute('data-status');
                const dateStr = item.getAttribute('data-date');
                const title = item.getAttribute('data-title').toLowerCase();
                
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                const matchesDate = dateFilter === 'all' || matchesDateFilter(dateStr, dateFilter);
                const matchesSearch = searchFilter === '' || title.includes(searchFilter);
                
                if (matchesStatus && matchesDate && matchesSearch) {
                    item.classList.remove('d-none');
                    visibleCount++;
                } else {
                    item.classList.add('d-none');
                }
            });
            
            // Mostrar ou esconder mensagem de nenhum resultado
            if (visibleCount === 0) {
                document.getElementById('noResults').classList.remove('d-none');
            } else {
                document.getElementById('noResults').classList.add('d-none');
            }
        }

        // Função para verificar se uma data corresponde ao filtro
        function matchesDateFilter(dateStr, filter) {
            if (!dateStr) return false;
            
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const nextWeekStart = new Date(today);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7 - nextWeekStart.getDay());
            
            const nextWeekEnd = new Date(nextWeekStart);
            nextWeekEnd.setDate(nextWeekEnd.getDate() + 6);
            
            const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            switch (filter) {
                case 'today':
                    return date >= today && date < tomorrow;
                case 'tomorrow':
                    return date >= tomorrow && date < new Date(tomorrow.getTime() + 24 * 60 * 60 * 1000);
                case 'this_week':
                    return date >= today && date < nextWeekStart;
                case 'next_week':
                    return date >= nextWeekStart && date <= nextWeekEnd;
                case 'this_month':
                    return date >= today && date <= thisMonthEnd;
                default:
                    return true;
            }
        }

        // Função para mostrar detalhes da postagem
        async function showPostDetails(postId) {
            try {
                const post = await api.posts.get(postId);
                
                // Preencher modal com dados da postagem
                document.getElementById('modalPostTitle').textContent = post.title;
                document.getElementById('modalPostStatus').innerHTML = `<span class="badge bg-${getStatusBadgeClass(post.queue_status)}">${getStatusLabel(post.queue_status)}</span>`;
                
                const scheduledDate = post.scheduled_at ? new Date(post.scheduled_at) : null;
                document.getElementById('modalPostScheduledAt').textContent = scheduledDate ? formatDateTime(scheduledDate) : 'Não agendada';
                
                const publishedDate = post.published_at ? new Date(post.published_at) : null;
                document.getElementById('modalPostPublishedAt').textContent = publishedDate ? formatDateTime(publishedDate) : 'Não publicada';
                
                document.getElementById('modalPostCategory').textContent = post.category?.name || 'Sem categoria';
                document.getElementById('modalPostRetryCount').textContent = post.retry_count || '0';
                
                // Converter markdown para HTML se o conteúdo parecer ser markdown
                if (post.content.includes('#') || post.content.includes('*')) {
                    document.getElementById('modalPostContent').innerHTML = marked.parse(post.content);
                } else {
                    document.getElementById('modalPostContent').innerHTML = post.content.replace(/\n/g, '<br>');
                }
                
                // Mostrar motivo da falha se aplicável
                if (post.queue_status === 'failed' && post.failure_reason) {
                    document.getElementById('modalPostFailureReason').classList.remove('d-none');
                    document.getElementById('modalPostFailureReasonText').textContent = post.failure_reason;
                } else {
                    document.getElementById('modalPostFailureReason').classList.add('d-none');
                }
                
                // Configurar botões de ação
                document.getElementById('modalPostEditBtn').href = `../posts/edit.html?id=${postId}`;
                
                const retryBtn = document.getElementById('modalPostRetryBtn');
                if (post.queue_status === 'failed') {
                    retryBtn.classList.remove('d-none');
                    retryBtn.onclick = function() {
                        retryPost(postId);
                        bootstrap.Modal.getInstance(document.getElementById('postDetailsModal')).hide();
                    };
                } else {
                    retryBtn.classList.add('d-none');
                }
                
                const cancelBtn = document.getElementById('modalPostCancelBtn');
                if (post.queue_status === 'pending') {
                    cancelBtn.classList.remove('d-none');
                    cancelBtn.onclick = function() {
                        cancelPost(postId);
                        bootstrap.Modal.getInstance(document.getElementById('postDetailsModal')).hide();
                    };
                } else {
                    cancelBtn.classList.add('d-none');
                }
                
                const processNowBtn = document.getElementById('modalPostProcessNowBtn');
                if (post.queue_status === 'pending') {
                    processNowBtn.classList.remove('d-none');
                    processNowBtn.onclick = function() {
                        processPostNow(postId);
                        bootstrap.Modal.getInstance(document.getElementById('postDetailsModal')).hide();
                    };
                } else {
                    processNowBtn.classList.add('d-none');
                }
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('postDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Erro ao carregar detalhes da postagem:', error);
                showAlert('Erro ao carregar detalhes da postagem. Por favor, tente novamente.', 'danger');
            }
        }

        // Função para tentar novamente uma postagem que falhou
        async function retryPost(postId) {
            try {
                await api.queue.retry(postId);
                showAlert('Postagem colocada novamente na fila!', 'success');
                loadQueueData();
            } catch (error) {
                console.error('Erro ao tentar novamente a postagem:', error);
                showAlert('Erro ao tentar novamente a postagem. Por favor, tente novamente.', 'danger');
            }
        }

        // Função para cancelar uma postagem agendada
        async function cancelPost(postId) {
            try {
                await api.queue.cancel(postId);
                showAlert('Agendamento cancelado com sucesso!', 'success');
                loadQueueData();
            } catch (error) {
                console.error('Erro ao cancelar agendamento:', error);
                showAlert('Erro ao cancelar agendamento. Por favor, tente novamente.', 'danger');
            }
        }

        // Função para processar uma postagem imediatamente
        async function processPostNow(postId) {
            try {
                await api.queue.processNow(postId);
                showAlert('Postagem enviada para processamento imediato!', 'success');
                loadQueueData();
            } catch (error) {
                console.error('Erro ao processar postagem:', error);
                showAlert('Erro ao processar postagem. Por favor, tente novamente.', 'danger');
            }
        }

        // Função para salvar a ordem da fila
        async function saveQueueOrder(postIds) {
            try {
                await api.queue.reorder(postIds);
                return true;
            } catch (error) {
                console.error('Erro ao salvar ordem da fila:', error);
                throw error;
            }
        }

        // Função para formatar data e hora
        function formatDateTime(date) {
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // Função para truncar texto
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Função para obter classe de badge de status
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'primary';
                case 'processing': return 'info';
                case 'published': return 'success';
                case 'failed': return 'danger';
                case 'cancelled': return 'secondary';
                default: return 'secondary';
            }
        }

        // Função para obter label de status
        function getStatusLabel(status) {
            switch (status) {
                case 'pending': return 'Pendente';
                case 'processing': return 'Em Processamento';
                case 'published': return 'Publicada';
                case 'failed': return 'Falha';
                case 'cancelled': return 'Cancelada';
                default: return 'Desconhecido';
            }
        }

        // Função para mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-fechar após 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
    </script>
</body>
</html>
